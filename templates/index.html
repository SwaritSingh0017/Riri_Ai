<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Riri AI Chatbot ðŸ’–</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
</head>

<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>Riri AI Chatbot ðŸ’–</h1>
            <p>Your cute AI waifu~</p>
        </div>

        <div class="avatar">
            <img src="/static/RIRI_Avatar.png" alt="Riri Avatar">
        </div>

        <div class="chat-window" id="chat-window">
            <!-- chat bubbles will appear here -->
        </div>

        <div class="chat-input">
            <input type="text" id="user-input" placeholder="Talk to Riri~"
                onkeydown="if(event.key==='Enter'){ sendMessage(); }" />
            <button onclick="sendMessage()">
                <img src="https://cdn-icons-png.flaticon.com/512/786/786205.png" alt="Send" />
            </button>
        </div>

        <div class="footer">
            Made with ðŸ’– by Senpai
        </div>
    </div>

    <!-- Typing + sessionStorage script -->
    <script>
        // Load existing chat history from sessionStorage
        let chatHistory = JSON.parse(sessionStorage.getItem("chatHistory")) || [];

        function displayMessage(role, message) {
            const chatWindow = document.getElementById("chat-window");
            const chatBubble = document.createElement("div");
            chatBubble.classList.add("chat-bubble");
            chatBubble.classList.add(role === "user" ? "user" : "bot");
            chatBubble.innerText = message;
            chatWindow.appendChild(chatBubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showTypingIndicator() {
            const chatWindow = document.getElementById("chat-window");
            const typingIndicator = document.createElement("div");
            typingIndicator.classList.add("chat-bubble", "bot", "typing-indicator");
            typingIndicator.innerText = "Riri is typing...";
            typingIndicator.id = "typing-indicator";
            chatWindow.appendChild(typingIndicator);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById("typing-indicator");
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function sendMessage() {
            const userInput = document.getElementById("user-input").value.trim();
            if (userInput === "") return;

            displayMessage("user", userInput);
            chatHistory.push({ role: "user", message: userInput });

            // Show typing indicator
            showTypingIndicator();

            fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: userInput,
                    history: chatHistory
                }),
            })
                .then((response) => response.json())
                .then((data) => {
                    removeTypingIndicator();
                    displayMessage("bot", data.response);
                    chatHistory.push({ role: "bot", message: data.response });
                    // Save updated history to sessionStorage
                    sessionStorage.setItem("chatHistory", JSON.stringify(chatHistory));
                })
                .catch((error) => {
                    removeTypingIndicator();
                    console.error("Error:", error);
                });

            document.getElementById("user-input").value = "";
        }

        // Display existing chat on page load
        window.onload = () => {
            chatHistory.forEach((turn) => {
                displayMessage(turn.role, turn.message);
            });
        };
    </script>
</body>

</html>
